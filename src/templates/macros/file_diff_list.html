{% from "macros/stage_status_icon.html" import stage_status_icon %}

{# Macro to render path segments with status icons for stage runs #}
{% macro render_path_with_icons(path_segments) %}
    {% for segment in path_segments %}
        {% if not loop.first %}<span style="color: #8b949e; margin: 0 4px;">/</span>{% endif %}
        <span style="color: #c9d1d9;">{{ segment.name }}</span>
        {% if segment.segment_type == 'stagerun' %}
            <span style="margin-left: 6px;">{{ stage_status_icon(segment.status) }}</span>
        {% endif %}
    {% endfor %}
{% endmacro %}

{% macro file_diff_list(file_diffs, repo_name, branch_or_ref) %}
{#
    Render a list of file diffs with view links and path segments.

    Args:
        file_diffs: List of FileDiffView objects
        repo_name: Repository name
        branch_or_ref: Branch name or commit hash to link to
#}
{% if file_diffs %}
    <div style="margin-bottom: 16px;">
        <div class="card" style="padding: 12px 16px;">
            <strong>{{ file_diffs|length }} file{% if file_diffs|length != 1 %}s{% endif %} changed</strong>
        </div>
    </div>

    {% for file_diff in file_diffs %}
        <div class="card" style="margin-bottom: 16px; padding: 0; overflow: hidden;">
            <!-- File header -->
            <div style="padding: 8px 16px; background-color: #161b22; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if file_diff.event_type == 'added' %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #3fb950; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">A</span>
                        <div style="font-family: monospace; font-weight: 600; display: flex; align-items: center;">
                            {{ render_path_with_icons(file_diff.path_segments) }}
                        </div>
                    {% elif file_diff.event_type == 'removed' %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #f85149; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">D</span>
                        <div style="font-family: monospace; font-weight: 600; display: flex; align-items: center;">
                            {{ render_path_with_icons(file_diff.path_segments) }}
                        </div>
                    {% else %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #d29922; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">M</span>
                        <div style="font-family: monospace; font-weight: 600; display: flex; align-items: center;">
                            {{ render_path_with_icons(file_diff.path_segments) }}
                        </div>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    {% if file_diff.lines and not file_diff.is_binary %}
                        {% set additions = file_diff.lines | selectattr('change_type', 'equalto', 'add') | list | length %}
                        {% set deletions = file_diff.lines | selectattr('change_type', 'equalto', 'remove') | list | length %}
                        {% if additions > 0 or deletions > 0 %}
                            <div style="display: flex; gap: 12px; font-size: 12px; font-family: monospace;">
                                {% if additions > 0 %}
                                    <span style="color: #3fb950;">+{{ additions }}</span>
                                {% endif %}
                                {% if deletions > 0 %}
                                    <span style="color: #f85149;">-{{ deletions }}</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                    {# View link - show for added/modified files (not removed) #}
                    {% if file_diff.event_type != 'removed' %}
                        {# Check if this is a stage-derived file (has stage run segments) #}
                        {% set has_stage_segment = file_diff.path_segments | selectattr('segment_type', 'equalto', 'stagerun') | list | length > 0 %}
                        {% if has_stage_segment %}
                            <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch_or_ref, stage_path=file_diff.path) }}"
                               style="font-size: 12px; color: #58a6ff; text-decoration: none; padding: 4px 8px; border: 1px solid #30363d; border-radius: 4px; background-color: #21262d; white-space: nowrap;"
                               onmouseover="this.style.borderColor='#58a6ff'"
                               onmouseout="this.style.borderColor='#30363d'">
                                View
                            </a>
                        {% else %}
                            <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=branch_or_ref, file_path=file_diff.path) }}"
                               style="font-size: 12px; color: #58a6ff; text-decoration: none; padding: 4px 8px; border: 1px solid #30363d; border-radius: 4px; background-color: #21262d; white-space: nowrap;"
                               onmouseover="this.style.borderColor='#58a6ff'"
                               onmouseout="this.style.borderColor='#30363d'">
                                View
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Diff content -->
            {% if file_diff.is_binary %}
                <div style="padding: 16px; text-align: center; color: #8b949e;">
                    Binary file not shown
                </div>
            {% elif file_diff.lines %}
                <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 12px;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0;">
                        <tbody>
                            {% for line in file_diff.lines %}
                                <tr style="
                                    {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.15);
                                    {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.15);
                                    {% endif %}
                                ">
                                    <!-- Old line number -->
                                    <td style="width: 40px; padding: 0 8px; text-align: right; color: #8b949e; user-select: none; border-right: 1px solid #30363d;
                                        {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.1);
                                        {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.1);
                                        {% endif %}
                                    ">
                                        {% if line.line_number_old %}{{ line.line_number_old }}{% endif %}
                                    </td>
                                    <!-- New line number -->
                                    <td style="width: 40px; padding: 0 8px; text-align: right; color: #8b949e; user-select: none; border-right: 1px solid #30363d;
                                        {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.1);
                                        {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.1);
                                        {% endif %}
                                    ">
                                        {% if line.line_number_new %}{{ line.line_number_new }}{% endif %}
                                    </td>
                                    <!-- Change indicator -->
                                    <td style="width: 20px; padding: 0 4px; text-align: center; user-select: none;
                                        {% if line.change_type == 'add' %}color: #3fb950;
                                        {% elif line.change_type == 'remove' %}color: #f85149;
                                        {% endif %}
                                    ">
                                        {% if line.change_type == 'add' %}+
                                        {% elif line.change_type == 'remove' %}âˆ’
                                        {% endif %}
                                    </td>
                                    <!-- Line content -->
                                    <td style="padding: 0 8px; white-space: pre-wrap; word-break: break-all;">{{ line.content }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="padding: 16px; text-align: center; color: #8b949e;">
                    File {% if file_diff.event_type == 'added' %}added{% elif file_diff.event_type == 'removed' %}removed{% else %}modified{% endif %} (empty or no changes to display)
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <div class="card" style="padding: 32px; text-align: center;">
        <div style="color: #8b949e; margin-bottom: 8px;">
            <svg style="width: 48px; height: 48px; opacity: 0.5;" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 2a.5.5 0 0 1 .5.5V6h3.5a.5.5 0 0 1 0 1H8.5v3.5a.5.5 0 0 1-1 0V7H4a.5.5 0 0 1 0-1h3.5V2.5A.5.5 0 0 1 8 2z"/>
            </svg>
        </div>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No differences</div>
        <div style="color: #8b949e;">
            No changes to display.
        </div>
    </div>
{% endif %}
{% endmacro %}
