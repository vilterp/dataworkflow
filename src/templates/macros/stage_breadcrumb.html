{% from "macros/stage_status_icon.html" import stage_status_icon %}

{% macro breadcrumb(repo_name, branch, path, show_repo_name=True) %}
{#
    Display breadcrumb navigation for any view (tree, blob, or stage).

    Args:
        repo_name: Name of the repository
        branch: Branch or commit hash being viewed
        path: List of PathSegment objects representing the path from root to current location
              Each segment has: name, segment_type (TREE/STAGERUN/FILE via SegmentType enum)
              StageRunSegment also has: status
              FileSegment also has: is_derived
        show_repo_name: Whether to show the repository name link (default: True)
#}
<div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
    {# Branch badge #}
    <div style="background-color: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 5px 12px; flex-shrink: 0;">
        <a href="{{ url_for('repo.branches', repo_name=repo_name) }}" style="color: #58a6ff; text-decoration: none; font-weight: 500;">{{ branch }}</a>
    </div>

    {# Repository root #}
    {% if show_repo_name %}
        {% if branch == 'main' %}
            <a href="{{ url_for('repo.repo', repo_name=repo_name) }}" style="color: #58a6ff; flex-shrink: 0;">{{ repo_name }}</a>
        {% else %}
            <a href="{{ url_for('repo.tree_view', repo_name=repo_name, branch=branch) }}" style="color: #58a6ff; flex-shrink: 0;">{{ repo_name }}</a>
        {% endif %}
    {% endif %}

    {# Path segments #}
    {% for i in range(path|length) %}
        {% set segment = path[i] %}
        {% set is_last = (i == path|length - 1) %}

        <span style="color: #8b949e; flex-shrink: 0;">/</span>

        {# Determine if this segment should be clickable #}
        {% set is_clickable = not is_last %}

        {# Build the URL for this segment (if clickable) #}
        {% if is_clickable %}
            {# Build incremental path up to this segment #}
            {% set incremental_segments = path[:i+1] %}

            {# Check if path contains any stage runs - if so, use stage_view #}
            {% set has_stage_runs = namespace(value=false) %}
            {% for seg in incremental_segments %}
                {% if seg.segment_type.value == 'stagerun' %}
                    {% set has_stage_runs.value = true %}
                {% endif %}
            {% endfor %}

            {% if has_stage_runs.value %}
                {# Stage view URL: workflow_file/stage1/stage2/... #}
                {% set path_parts = [] %}
                {% for seg in incremental_segments %}
                    {% set _ = path_parts.append(seg.name) %}
                {% endfor %}
                {% set stage_path = '/'.join(path_parts) %}
                <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch, stage_path=stage_path) }}" style="color: #58a6ff; flex-shrink: 0;">{{ segment.name }}</a>
            {% elif segment.segment_type.value == 'tree' %}
                {# Tree view URL #}
                {% set path_parts = [] %}
                {% for seg in incremental_segments %}
                    {% set _ = path_parts.append(seg.name) %}
                {% endfor %}
                {% set dir_path = '/'.join(path_parts) %}
                <a href="{{ url_for('repo.tree_view', repo_name=repo_name, branch=branch, dir_path=dir_path) }}" style="color: #58a6ff; flex-shrink: 0;">{{ segment.name }}</a>
            {% elif segment.segment_type.value == 'file' %}
                {# Blob view URL #}
                {% set path_parts = [] %}
                {% for seg in incremental_segments %}
                    {% set _ = path_parts.append(seg.name) %}
                {% endfor %}
                {% set file_path = '/'.join(path_parts) %}
                <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=branch, file_path=file_path) }}" style="color: #58a6ff; flex-shrink: 0;">{{ segment.name }}</a>
            {% endif %}
        {% else %}
            {# Non-clickable (current page) #}
            <span style="color: #c9d1d9; flex-shrink: 0;">{{ segment.name }}</span>
        {% endif %}

        {# Show status icon for stage run segments #}
        {% if segment.segment_type.value == 'stagerun' %}
            <span style="margin-left: 3px;">{{ stage_status_icon(segment.status) }}</span>
        {% endif %}
    {% endfor %}
</div>
{% endmacro %}
