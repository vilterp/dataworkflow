{% extends "base.html" %}
{% from "macros/file_diff_list.html" import file_diff_list %}
{% from "macros/commit_header.html" import commit_header %}

{% block title %}#{{ pr.number }} {{ pr.title }} - {{ repo_name }}{% endblock %}

{% block content %}
<div style="margin-top: 24px;">
    <!-- PR Header -->
    <div style="margin-bottom: 24px;">
        <h1 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
            {{ pr.title }}
            <span style="color: #8b949e; font-size: 24px; font-weight: 400;">#{{ pr.number }}</span>
        </h1>

        <!-- Status badges -->
        <div style="display: flex; align-items: center; gap: 12px; font-size: 14px;">
            {% if pr.status.value == 'open' %}
                <span style="background-color: #238636; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path>
                        <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path>
                    </svg>
                    Open
                </span>
            {% elif pr.status.value == 'merged' %}
                <span style="background-color: #8957e5; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M5.45 5.154A4.25 4.25 0 0 0 9.25 7.5h1.378a2.251 2.251 0 1 1 0 1.5H9.25A5.734 5.734 0 0 1 5 7.123v3.505a2.25 2.25 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.95-.218ZM4.25 13.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm8.5-4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5ZM5 3.25a.75.75 0 1 0 0 .005V3.25Z"></path>
                    </svg>
                    Merged
                </span>
            {% else %}
                <span style="background-color: #8b949e; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M11.28 6.78a.75.75 0 0 0-1.06-1.06L7.25 8.69 5.78 7.22a.75.75 0 0 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l3.5-3.5Z"></path>
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0Zm-1.5 0a6.5 6.5 0 1 0-13 0 6.5 6.5 0 0 0 13 0Z"></path>
                    </svg>
                    Closed
                </span>
            {% endif %}

            <span style="color: #8b949e;">
                <strong>{{ pr.author }}</strong> wants to merge from
                <code style="background-color: #6e7681; color: #c9d1d9; padding: 2px 6px; border-radius: 3px; font-size: 12px;">{{ pr.head_branch }}</code>
                into
                <code style="background-color: #6e7681; color: #c9d1d9; padding: 2px 6px; border-radius: 3px; font-size: 12px;">{{ pr.base_branch }}</code>
            </span>
        </div>
    </div>

    <!-- Main content area -->
    <div>
        <!-- Tabs and content -->
        <div>
            <!-- Tabs -->
            <div style="border-bottom: 1px solid #30363d; margin-bottom: 16px;">
                <nav style="display: flex; gap: 0;">
                    <a href="{{ url_for('pull_requests.pull_request_detail', repo_name=repo_name, pr_number=pr.number, tab='conversation') }}"
                       style="padding: 8px 16px; color: {% if current_tab == 'conversation' %}#c9d1d9{% else %}#8b949e{% endif %}; text-decoration: none; {% if current_tab == 'conversation' %}border-bottom: 2px solid #f78166; margin-bottom: -1px;{% endif %} transition: all 0.2s;">
                        Conversation
                    </a>
                    <a href="{{ url_for('pull_requests.pull_request_detail', repo_name=repo_name, pr_number=pr.number, tab='commits') }}"
                       style="padding: 8px 16px; color: {% if current_tab == 'commits' %}#c9d1d9{% else %}#8b949e{% endif %}; text-decoration: none; {% if current_tab == 'commits' %}border-bottom: 2px solid #f78166; margin-bottom: -1px;{% endif %} transition: all 0.2s;">
                        Commits
                        <span style="background-color: #6e7681; color: #c9d1d9; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 4px;">{{ commits|length }}</span>
                    </a>
                    <a href="{{ url_for('pull_requests.pull_request_detail', repo_name=repo_name, pr_number=pr.number, tab='files') }}"
                       style="padding: 8px 16px; color: {% if current_tab == 'files' %}#c9d1d9{% else %}#8b949e{% endif %}; text-decoration: none; {% if current_tab == 'files' %}border-bottom: 2px solid #f78166; margin-bottom: -1px;{% endif %} transition: all 0.2s;">
                        Files changed
                    </a>
                </nav>
            </div>

            <!-- Tab content -->
            {% if current_tab == 'conversation' %}
                <!-- Description -->
                <div style="background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                    <div style="margin-bottom: 8px;">
                        <strong>{{ pr.author }}</strong>
                        <span style="color: #8b949e; font-size: 14px;">commented {{ pr.created_at|timeago }}</span>
                    </div>
                    <div style="padding: 12px; background-color: #161b22; border-radius: 6px;">
                        {% if pr.description %}
                            <p style="margin: 0; white-space: pre-wrap;">{{ pr.description }}</p>
                        {% else %}
                            <p style="margin: 0; color: #8b949e; font-style: italic;">No description provided.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Commits (abbreviated) -->
                {% if commits %}
                    <div style="margin-bottom: 16px;">
                        <div style="color: #8b949e; font-size: 14px; margin-bottom: 8px;">
                            {{ commits|length }} commit{{ 's' if commits|length != 1 else '' }}
                        </div>
                        <div style="position: relative; padding-left: 32px;">
                            <!-- Vertical line connecting commits -->
                            <div style="position: absolute; left: 8px; top: 8px; bottom: 8px; width: 2px; background-color: #30363d;"></div>

                            {% for commit in commits %}
                                <div style="position: relative; display: flex; align-items: center; gap: 12px; padding: 4px 0;">
                                    <!-- Commit icon -->
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="#8b949e" style="position: absolute; left: -24px; background-color: #010409; z-index: 1;">
                                        <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
                                    </svg>

                                    <div style="flex: 1; min-width: 0; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ commit.message.split('\n')[0] }}
                                    </div>
                                    <a href="{{ url_for('repo.commit_detail', repo_name=repo_name, commit_hash=commit.hash) }}"
                                       class="hash"
                                       style="font-size: 11px; padding: 2px 6px; background-color: #161b22; border: 1px solid #30363d; border-radius: 4px; text-decoration: none; flex-shrink: 0;">
                                        {{ commit.hash[:7] }}
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Comments -->
                {% if pr.comments %}
                    {% for comment in pr.comments %}
                        <div style="background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                            <div style="margin-bottom: 8px;">
                                <strong>{{ comment.author }}</strong>
                                <span style="color: #8b949e; font-size: 14px;">commented {{ comment.created_at|timeago }}</span>
                            </div>
                            <div style="padding: 12px; background-color: #161b22; border-radius: 6px;">
                                <p style="margin: 0; white-space: pre-wrap;">{{ comment.body }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Add comment form (only if PR is open) -->
                {% if pr.status.value == 'open' %}
                    <div style="background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <form method="POST" action="{{ url_for('pull_requests.add_comment_route', repo_name=repo_name, pr_number=pr.number) }}">
                            <input type="hidden" name="author" value="System User">
                            <input type="hidden" name="author_email" value="system@dataworkflow.local">
                            <textarea name="body"
                                      placeholder="Leave a comment..."
                                      style="width: 100%; min-height: 100px; padding: 8px; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: inherit; font-size: 14px; resize: vertical; margin-bottom: 8px;"
                                      required></textarea>
                            <button type="submit"
                                    style="background-color: #238636; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Comment
                            </button>
                        </form>
                    </div>
                {% endif %}

                <!-- Merge section -->
                {% if pr.status.value == 'open' %}
                    <div style="background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 16px;">
                        {% if can_merge %}
                            <div style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 1px solid #2ea043; border-radius: 6px; margin-bottom: 12px; background-color: rgba(46, 160, 67, 0.1);">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="#3fb950" style="flex-shrink: 0;">
                                    <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
                                </svg>
                                <div>
                                    <div style="color: #3fb950; font-weight: 600; margin-bottom: 2px;">Ready to merge</div>
                                    <div style="color: #8b949e; font-size: 12px;">All checks have passed</div>
                                </div>
                            </div>
                        {% else %}
                            <div style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 1px solid #f85149; border-radius: 6px; margin-bottom: 12px; background-color: rgba(248, 81, 73, 0.1);">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="#f85149" style="flex-shrink: 0;">
                                    <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
                                </svg>
                                <div>
                                    <div style="color: #f85149; font-weight: 600; margin-bottom: 2px;">Cannot merge yet</div>
                                    <div style="color: #8b949e; font-size: 12px;">{{ merge_error }}</div>
                                </div>
                            </div>
                        {% endif %}

                        <div style="display: flex; gap: 8px;">
                            <form method="POST" action="{{ url_for('pull_requests.merge_pull_request_route', repo_name=repo_name, pr_number=pr.number) }}">
                                <input type="hidden" name="merged_by" value="System User">
                                <input type="hidden" name="merged_by_email" value="system@dataworkflow.local">
                                <button type="submit" {% if not can_merge %}disabled{% endif %}
                                        style="background-color: {% if can_merge %}#238636{% else %}#30363d{% endif %}; color: {% if can_merge %}white{% else %}#8b949e{% endif %}; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: {% if can_merge %}pointer{% else %}not-allowed{% endif %}; width: 180px;">
                                    Merge pull request
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('pull_requests.close_pull_request_route', repo_name=repo_name, pr_number=pr.number) }}">
                                <button type="submit"
                                        style="background-color: transparent; color: #c9d1d9; padding: 8px 16px; border: 1px solid #30363d; border-radius: 6px; font-weight: 600; cursor: pointer; width: 180px;">
                                    Close pull request
                                </button>
                            </form>
                        </div>
                    </div>
                {% elif pr.status.value == 'merged' %}
                    <div style="background-color: #8957e5; background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0)); padding: 16px; border-radius: 6px; border: 1px solid #30363d;">
                        <div style="color: white; font-weight: 600; margin-bottom: 4px;">Pull request successfully merged</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 12px;">
                            {{ pr.merged_by }} merged {{ commits|length }} commit{{ 's' if commits|length != 1 else '' }} into {{ pr.base_branch }} {{ pr.merged_at|timeago }}
                        </div>
                    </div>
                {% elif pr.status.value == 'closed' %}
                    <div style="background-color: #161b22; padding: 16px; border-radius: 6px; border: 1px solid #30363d;">
                        <div style="color: #8b949e; font-weight: 600; margin-bottom: 12px;">This pull request is closed</div>
                        <form method="POST" action="{{ url_for('pull_requests.reopen_pull_request_route', repo_name=repo_name, pr_number=pr.number) }}">
                            <button type="submit"
                                    style="background-color: transparent; color: #c9d1d9; padding: 8px 16px; border: 1px solid #30363d; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Reopen pull request
                            </button>
                        </form>
                    </div>
                {% endif %}

            {% elif current_tab == 'commits' %}
                <!-- Commits list -->
                <div style="background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px;">
                    {% for commit in commits %}
                        <div style="padding: 16px; border-bottom: 1px solid #30363d; {% if loop.last %}border-bottom: none;{% endif %}">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="width: 32px; height: 32px; background-color: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0;">
                                    {{ commit.author[0].upper() }}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">
                                        {{ commit.message.split('\n')[0] }}
                                    </div>
                                    <div style="font-size: 12px; color: #8b949e;">
                                        {{ commit.author }} committed {{ commit.committed_at|timeago }}
                                    </div>
                                </div>
                                <div>
                                    <a href="{{ url_for('repo.commit_detail', repo_name=repo_name, commit_hash=commit.hash) }}"
                                       class="hash"
                                       style="font-size: 12px; padding: 4px 8px; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; text-decoration: none;">
                                        {{ commit.hash[:7] }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

            {% elif current_tab == 'files' %}
                <!-- File diff -->
                {% if file_diffs %}
                    {{ file_diff_list(file_diffs, repo_name, pr.head_branch) }}
                {% else %}
                    <div style="text-align: center; padding: 48px; color: #8b949e; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px;">
                        No changes between {{ pr.base_branch }} and {{ pr.head_branch }}
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
var activeTab = '{{ active_tab|default("pulls") }}';
</script>
{% endblock %}
