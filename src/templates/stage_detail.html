{% extends "base.html" %}

{% block title %}{{ stage.name }} - Stages - {{ repo_name }}{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
        <div>
            <h1 style="margin-bottom: 8px;">{{ stage.name }}</h1>
            {% if stage.description %}
                <p style="color: #8b949e;">{{ stage.description }}</p>
            {% endif %}
            <div style="display: flex; gap: 16px; color: #8b949e; font-size: 12px; margin-top: 8px;">
                <span>Based on: <code style="font-size: 11px;">{{ stage.base_ref }}</code></span>
                <span>Created {{ stage.created_at|timeago }}</span>
            </div>
        </div>
        {% if not stage.committed %}
            <a href="{{ url_for('stages_list', repo_name=repo_name) }}" class="btn btn-secondary">
                Back to Stages
            </a>
        {% endif %}
    </div>
</div>

<!-- Upload Files Section -->
{% if not stage.committed %}
<div class="card" style="margin-bottom: 16px;">
    <h2 style="margin-bottom: 16px;">Upload Files</h2>
    <form method="POST" action="{{ url_for('stage_upload_file', repo_name=repo_name, stage_id=stage.id) }}" enctype="multipart/form-data">
        <div style="display: grid; grid-template-columns: 2fr 3fr auto; gap: 12px; align-items: end;">
            <div>
                <label for="path" style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 12px; color: #8b949e;">
                    File Path
                </label>
                <input
                    type="text"
                    id="path"
                    name="path"
                    required
                    style="width: 100%; padding: 8px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;"
                    placeholder="e.g., data.csv"
                />
            </div>
            <div>
                <label for="file" style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 12px; color: #8b949e;">
                    Choose File
                </label>
                <input
                    type="file"
                    id="file"
                    name="file"
                    required
                    style="width: 100%; padding: 6px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;"
                />
            </div>
            <button type="submit" class="btn">
                Add File
            </button>
        </div>
    </form>
</div>
{% endif %}

<!-- Files in Stage -->
<div class="card" style="padding: 0;">
    <div style="padding: 16px; border-bottom: 1px solid #30363d;">
        <h2 style="margin: 0;">Files ({{ files|length }})</h2>
    </div>

    {% if files %}
        <table style="margin: 0;">
            <thead>
                <tr>
                    <th style="width: 45%;">Path</th>
                    <th style="width: 10%;">Status</th>
                    <th style="width: 25%;">Blob Hash</th>
                    <th style="width: 15%;">Updated</th>
                    {% if not stage.committed %}
                        <th style="width: 5%;"></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                    <tr>
                        <td style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 13px;">
                            {{ file.path }}
                        </td>
                        <td>
                            {% set status = file_statuses.get(file.path, 'unknown') %}
                            {% if status == 'added' %}
                                <span style="color: #3fb950; font-size: 12px; font-weight: 500;">+ added</span>
                            {% elif status == 'modified' %}
                                <span style="color: #d29922; font-size: 12px; font-weight: 500;">~ modified</span>
                            {% elif status == 'unchanged' %}
                                <span style="color: #8b949e; font-size: 12px;">= unchanged</span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="hash">{{ file.blob_hash[:12] }}</code>
                        </td>
                        <td style="color: #8b949e; font-size: 12px;">
                            {{ file.updated_at|timeago }}
                        </td>
                        {% if not stage.committed %}
                            <td style="text-align: right;">
                                <form method="POST" action="{{ url_for('stage_delete_file', repo_name=repo_name, stage_id=stage.id, file_id=file.id) }}" style="display: inline;">
                                    <button type="submit" onclick="return confirm('Remove this file from the stage?')" style="background: none; border: none; color: #f85149; cursor: pointer; padding: 4px 8px;">
                                        ✕
                                    </button>
                                </form>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="padding: 40px; text-align: center; color: #8b949e;">
            <p>No files in this stage yet</p>
            {% if not stage.committed %}
                <p style="font-size: 12px; margin-top: 8px;">Upload files using the form above</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Commit Section -->
{% if not stage.committed and files %}
<div class="card" style="margin-top: 16px;">
    <h2 style="margin-bottom: 16px;">Commit Stage</h2>
    <form method="POST" action="{{ url_for('stage_commit', repo_name=repo_name, stage_id=stage.id) }}">
        <div style="margin-bottom: 16px;">
            <label for="message" style="display: block; margin-bottom: 8px; font-weight: 500;">
                Commit Message <span style="color: #f85149;">*</span>
            </label>
            <textarea
                id="message"
                name="message"
                required
                rows="3"
                style="width: 100%; padding: 8px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px; font-family: inherit; resize: vertical;"
                placeholder="Describe your changes..."
            ></textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div>
                <label for="author" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Author Name
                </label>
                <input
                    type="text"
                    id="author"
                    name="author"
                    value="Anonymous"
                    style="width: 100%; padding: 8px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;"
                />
            </div>
            <div>
                <label for="author_email" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Author Email
                </label>
                <input
                    type="email"
                    id="author_email"
                    name="author_email"
                    value="anonymous@example.com"
                    style="width: 100%; padding: 8px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;"
                />
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 12px; font-weight: 500;">
                Commit Target
            </label>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <label style="display: flex; align-items: center; padding: 12px; background-color: #1c2128; border: 2px solid #30363d; border-radius: 6px; cursor: pointer;">
                    <input
                        type="radio"
                        name="commit_target"
                        value="base"
                        checked
                        onclick="document.getElementById('new_branch_input').style.display = 'none';"
                        style="margin-right: 12px;"
                    />
                    <div>
                        <div style="font-weight: 500; color: #c9d1d9;">Commit to base branch</div>
                        <div style="font-size: 12px; color: #8b949e; margin-top: 4px;">
                            Update <code style="font-size: 11px;">{{ stage.base_ref.replace('refs/heads/', '') }}</code> with this commit
                        </div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; padding: 12px; background-color: #1c2128; border: 2px solid #30363d; border-radius: 6px; cursor: pointer;">
                    <input
                        type="radio"
                        name="commit_target"
                        value="new_branch"
                        onclick="document.getElementById('new_branch_input').style.display = 'block';"
                        style="margin-right: 12px;"
                    />
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #c9d1d9;">Create new branch</div>
                        <div style="font-size: 12px; color: #8b949e; margin-top: 4px;">
                            Create a new branch from <code style="font-size: 11px;">{{ stage.base_ref.replace('refs/heads/', '') }}</code> with this commit
                        </div>
                    </div>
                </label>
            </div>
            <div id="new_branch_input" style="display: none; margin-top: 12px; margin-left: 12px;">
                <label for="new_branch_name" style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">
                    New Branch Name
                </label>
                <input
                    type="text"
                    id="new_branch_name"
                    name="new_branch_name"
                    placeholder="e.g., feature-update"
                    style="width: 100%; padding: 8px 12px; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px;"
                />
            </div>
        </div>

        <button type="submit" class="btn" onclick="return confirm('Create commit from this stage? This action cannot be undone.')">
            Commit {{ files|length }} file{% if files|length != 1 %}s{% endif %}
        </button>
    </form>
</div>
{% endif %}

<!-- Committed State -->
{% if stage.committed %}
<div class="card" style="margin-top: 16px; background-color: #1a4d2e; border-color: #238636;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 20px;">✓</span>
        <div>
            <div style="font-weight: 500; color: #7ee787;">Stage Committed</div>
            <div style="font-size: 12px; color: #a2e9b4; margin-top: 4px;">
                Committed {{ stage.committed_at|timeago }} as
                <a href="{{ url_for('commit_detail', repo_name=repo_name, commit_hash=stage.commit_hash) }}" class="hash">
                    {{ stage.commit_hash[:7] }}
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
