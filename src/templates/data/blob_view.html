{% extends "base.html" %}
{% from "macros/commit_header.html" import commit_header %}
{% from "macros/stage_status_icon.html" import stage_status_icon %}
{% from "macros/blob_content.html" import blob_content %}

{% block title %}{{ file_path }} - {{ repo_name }}{% endblock %}

{% block content %}
<!-- Branch and File Path Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; align-items: center;">
        <div style="background-color: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 5px 12px;">
            <span style="font-weight: 500;">{{ branch }}</span>
        </div>
        <a href="{{ url_for('repo.repo', repo_name=repo_name) }}" style="color: #58a6ff;">{{ repo_name }}</a>
        <span style="color: #8b949e;">/</span>
        <span style="color: #c9d1d9;">{{ file_path }}</span>
    </div>
    <div style="display: flex; gap: 8px; margin-left: auto;">
        {% if is_python_file %}
            <a href="{{ url_for('workflow_ui.workflow_dispatch', repo_name=repo_name) }}?workflow_file={{ file_path }}&branch={{ branch }}"
               title="Dispatch workflow"
               style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #1f6feb; color: white; border: 1px solid rgba(240,246,252,0.1); border-radius: 6px; text-decoration: none; font-size: 14px;">
                â–¶
            </a>
        {% endif %}
        <a href="{{ url_for('repo.download_blob', repo_name=repo_name, branch=branch, file_path=file_path) }}"
           title="Download"
           style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; text-decoration: none; font-size: 16px;">
            â†“
        </a>
        <a href="{{ url_for('repo.replace_file', repo_name=repo_name, ref=branch, file_path=file_path) }}"
           title="Upload replacement"
           style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #238636; color: white; border: 1px solid rgba(240,246,252,0.1); border-radius: 6px; text-decoration: none; font-size: 16px;">
            â†‘
        </a>
        <a href="{{ url_for('repo_edit.edit_blob', repo_name=repo_name, branch=branch, file_path=file_path) }}"
           title="Edit file"
           style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; text-decoration: none; font-size: 16px;">
            âœï¸
        </a>
        <form method="POST" action="{{ url_for('repo.delete_file', repo_name=repo_name, ref=branch, file_path=file_path) }}" style="display: inline; margin: 0;">
            <button type="submit"
                    title="Delete file"
                    style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #da3633; color: white; border: 1px solid rgba(240,246,252,0.1); border-radius: 6px; cursor: pointer; font-size: 16px; font-family: inherit; padding: 0;"
                    onclick="return confirm('Are you sure you want to delete {{ file_path }}?');">
                ğŸ—‘ï¸
            </button>
        </form>
    </div>
</div>

{{ commit_header(commit, repo_name, commit_count, branch, file_path, stage_run_count, has_failed, has_running, has_completed) }}

<!-- Stage Runs List (for Python workflow files) -->
{% if file_stage_runs and file_stage_runs|length > 0 %}
<div class="card" style="padding: 0; margin-top: 0; border-radius: 0; border-top: 1px solid #30363d;">
    <div style="padding: 12px 16px; background-color: #0d1117; border-bottom: 1px solid #30363d;">
        <span style="font-weight: 600; color: #c9d1d9;">Stage Runs</span>
        <span style="color: #8b949e; font-size: 12px; margin-left: 8px;">({{ file_stage_runs|length }})</span>
    </div>
    <table style="margin: 0;">
        <tbody>
            {% for stage_run in file_stage_runs %}
                <tr style="border-bottom: 1px solid #30363d;">
                    <td style="width: 24px; padding: 8px 8px 8px 16px;">
                        <span style="color: #8b949e; font-size: 16px;">âš™ï¸</span>
                    </td>
                    <td style="padding: 8px 16px;">
                        <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch, stage_path=file_path + '/' + stage_run.stage_name) }}">{{ stage_run.stage_name }}</a>
                        <span style="margin-left: 8px;">{{ stage_status_icon(stage_run.status.value) }}</span>
                        {% if stage_run.status.value in ['running', 'failed', 'pending'] %}
                            <span style="color: #8b949e; font-size: 12px; margin-left: 4px;">{{ stage_run.status.value }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 8px 16px; color: #8b949e; font-size: 12px;">
                        {% if stage_run.result_value %}
                            <code style="background-color: #161b22; padding: 2px 6px; border-radius: 3px; font-size: 11px;">{{ stage_run.result_value[:50] }}{% if stage_run.result_value|length > 50 %}...{% endif %}</code>
                        {% else %}
                            Stage run
                        {% endif %}
                    </td>
                    <td style="padding: 8px 16px; text-align: right; color: #8b949e; font-size: 12px; white-space: nowrap;">
                        {% if stage_run.completed_at %}
                            {{ stage_run.completed_at|timeago }}
                        {% elif stage_run.started_at %}
                            started {{ stage_run.started_at|timeago }}
                        {% else %}
                            created {{ stage_run.created_at|timeago }}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- File Content -->
{{ blob_content(content, is_binary, blob.size, url_for('repo.download_blob', repo_name=repo_name, branch=branch, file_path=file_path)) }}
{% endblock %}
