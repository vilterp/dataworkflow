{% extends "base.html" %}
{% from "macros/commit_header.html" import commit_header %}
{% from "macros/stage_list.html" import stage_list %}

{% block title %}{{ workflow_file }} - {{ repo_name }}{% endblock %}

{% block content %}
<!-- Branch and Stage Path Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; align-items: center;">
        <div style="background-color: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 5px 12px;">
            <span style="font-weight: 500;">{{ branch }}</span>
        </div>
        <span style="color: #8b949e;">/</span>
        <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=branch, file_path=workflow_file) }}" style="color: #58a6ff;">{{ workflow_file }}</a>
        {% if stage_path %}
            {% set path_parts = stage_path.split('/') %}
            {% for i in range(1, path_parts|length) %}
                {% set stage_name = path_parts[i] %}
                <span style="color: #8b949e;">/</span>
                {% if i < path_parts|length - 1 %}
                    {% set incremental_path = '/'.join(path_parts[:i+1]) %}
                    <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch, stage_path=incremental_path) }}" style="color: #58a6ff;">{{ stage_name }}</a>
                {% else %}
                    <span style="color: #c9d1d9;">{{ stage_name }}</span>
                    {% if stage_run %}
                        {% if stage_run.status.value == 'completed' %}
                            <span style="color: #3fb950; font-size: 12px;">✓</span>
                        {% elif stage_run.status.value == 'running' %}
                            <span style="color: #58a6ff; font-size: 12px;">⟳</span>
                        {% elif stage_run.status.value == 'failed' %}
                            <span style="color: #f85149; font-size: 12px;">✗</span>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% else %}
            <span style="color: #8b949e;">/</span>
            <span style="color: #c9d1d9;">root stages</span>
        {% endif %}
    </div>
</div>

{{ commit_header(commit, repo_name, commit_count, branch, workflow_file, stage_run_count, has_failed, has_running, has_completed) }}

{% if stage_run %}
<!-- Stage Run Details -->
<div class="card" style="border-radius: 0; border-top: 1px solid #30363d; border-bottom: 0; padding: 12px 16px; margin: 0; background-color: #0d1117;">
    <div style="display: flex; gap: 24px; font-size: 12px;">
        <div>
            <span style="color: #8b949e;">Status:</span>
            {% if stage_run.status.value == 'completed' %}
                <span style="color: #3fb950;">✓ Completed</span>
            {% elif stage_run.status.value == 'running' %}
                <span style="color: #58a6ff;">⟳ Running</span>
            {% elif stage_run.status.value == 'failed' %}
                <span style="color: #f85149;">✗ Failed</span>
            {% elif stage_run.status.value == 'pending' %}
                <span style="color: #8b949e;">⋯ Pending</span>
            {% endif %}
        </div>
        {% if stage_run.started_at %}
        <div>
            <span style="color: #8b949e;">Started:</span>
            <span>{{ stage_run.started_at|timeago }}</span>
        </div>
        {% endif %}
        {% if stage_run.completed_at %}
        <div>
            <span style="color: #8b949e;">Completed:</span>
            <span>{{ stage_run.completed_at|timeago }}</span>
        </div>
        {% endif %}
        {% if stage_run.result_value %}
        <div>
            <span style="color: #8b949e;">Result:</span>
            <code style="background-color: #161b22; padding: 2px 6px; border-radius: 3px;">{{ stage_run.result_value }}</code>
        </div>
        {% endif %}
    </div>
    {% if stage_run.error_message %}
    <div style="margin-top: 8px; padding: 8px; background-color: #161b22; border: 1px solid #f85149; border-radius: 4px;">
        <span style="color: #f85149; font-weight: 500;">Error:</span>
        <pre style="margin: 4px 0 0 0; color: #f85149; font-size: 11px; white-space: pre-wrap;">{{ stage_run.error_message }}</pre>
    </div>
    {% endif %}
</div>
{% endif %}

{{ stage_list(child_stages, stage_files, repo_name, branch, workflow_file, stage_path) }}
{% endblock %}
