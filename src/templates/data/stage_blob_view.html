{% extends "base.html" %}
{% from "macros/commit_header.html" import commit_header %}

{% block title %}{{ file_path }} (derived) - {{ repo_name }}{% endblock %}

{% block content %}
<!-- Branch and Stage File Path Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; align-items: center;">
        <div style="background-color: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 5px 12px;">
            <span style="font-weight: 500;">{{ branch }}</span>
        </div>
        <span style="color: #8b949e;">/</span>
        <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=branch, file_path=workflow_file) }}" style="color: #58a6ff;">{{ workflow_file }}</a>
        {% if stage_path %}
            {% set path_parts = stage_path.split('/') %}
            {% for i in range(1, path_parts|length) %}
                {% set part = path_parts[i] %}
                <span style="color: #8b949e;">/</span>
                {% if i < path_parts|length - 1 %}
                    {# This is a stage in the chain - make it clickable #}
                    {% set incremental_path = '/'.join(path_parts[:i+1]) %}
                    <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch, stage_path=incremental_path) }}" style="color: #58a6ff;">{{ part }}</a>
                {% else %}
                    {# This is the final file name - not clickable #}
                    <span style="color: #c9d1d9;">{{ part }}</span>
                    <span style="color: #6e7681; font-size: 12px; margin-left: 8px;">(derived)</span>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    <div style="display: flex; gap: 8px; margin-left: auto;">
        <!-- Only show download button for derived data (no edit/replace/delete) -->
        <a href="{{ url_for('workflows_api.download_stage_file', file_id=stage_file.id) }}"
           title="Download"
           style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; text-decoration: none; font-size: 16px;">
            â†“
        </a>
    </div>
</div>

{{ commit_header(commit, repo_name, commit_count, branch, workflow_file, stage_run_count, has_failed, has_running, has_completed) }}

<!-- Stage File Metadata -->
<div class="card" style="border-radius: 0; border-top: 1px solid #30363d; border-bottom: 0; padding: 12px 16px; margin: 0; background-color: #0d1117;">
    <div style="display: flex; gap: 24px; font-size: 12px;">
        <div>
            <span style="color: #8b949e;">Generated by:</span>
            <a href="{{ url_for('repo.stage_view', repo_name=repo_name, branch=branch, stage_path=workflow_file + '/' + stage_run.stage_name) }}" style="color: #58a6ff;">{{ stage_run.stage_name }}</a>
        </div>
        <div>
            <span style="color: #8b949e;">Size:</span>
            <span>{{ stage_file.size|filesizeformat }}</span>
        </div>
        <div>
            <span style="color: #8b949e;">Created:</span>
            <span>{{ stage_file.created_at|timeago }}</span>
        </div>
        <div>
            <span style="color: #8b949e;">Content hash:</span>
            <code style="background-color: #161b22; padding: 2px 6px; border-radius: 3px;">{{ stage_file.content_hash[:12] }}...</code>
        </div>
    </div>
</div>

<!-- File Content -->
<div class="card" style="padding: 0; margin-top: 0; border-radius: 0 0 6px 6px;">
    {% if is_binary %}
        <div class="empty-state">
            <h3>Binary file</h3>
            <p>This file contains binary data and cannot be displayed as text.</p>
            <p class="commit-meta">Size: {{ stage_file.size }} bytes</p>
            <div style="margin-top: 16px;">
                <a href="{{ url_for('workflows_api.download_stage_file', file_id=stage_file.id) }}" class="btn">Download File</a>
            </div>
        </div>
    {% elif content %}
        <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 12px;">
            <table style="width: 100%; border-collapse: collapse; margin: 0;">
                <tbody>
                    {% for line in content.splitlines() %}
                        <tr>
                            <!-- Line number -->
                            <td style="width: 40px; padding: 0 8px; text-align: right; color: #8b949e; user-select: none; border-right: 1px solid #30363d; border-top: none; border-bottom: none; background-color: #0d1117;">
                                {{ loop.index }}
                            </td>
                            <!-- Line content -->
                            <td style="padding: 0 8px; white-space: pre; overflow-x: auto; border: none;">{{ line }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <h3>Empty file</h3>
            <p>This file has no content</p>
        </div>
    {% endif %}
</div>
{% endblock %}
