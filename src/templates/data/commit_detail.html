{% extends "base.html" %}
{% from "macros/commit_status_icon.html" import commit_status_icon %}

{% block title %}Commit {{ commit.hash[:7] }} - DataWorkflow{% endblock %}

{% block content %}
<div class="card">
    <div style="border-bottom: 1px solid #30363d; padding-bottom: 16px; margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
                <h1 style="margin-bottom: 8px;">{{ commit.message.split('\n')[0] }}</h1>
                <div class="commit-meta">
                    {{ commit.author }} &lt;{{ commit.author_email }}&gt; committed {{ commit.committed_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                </div>
            </div>
            {{ commit_status_icon(repo_name, commit.hash, stage_run_count, has_failed, has_running, has_completed) }}
        </div>
    </div>

    {% if commit.message.split('\n')|length > 1 %}
        <div style="margin-bottom: 20px; color: #c9d1d9;">
            <pre style="white-space: pre-wrap;">{{ '\n'.join(commit.message.split('\n')[1:]).strip() }}</pre>
        </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <strong>Commit:</strong>
            <code class="hash">{{ commit.hash }}</code>
        </div>
        <div>
            <strong>Parent:</strong>
            {% if commit.parent_hash %}
                <a href="{{ url_for('repo.commit_detail', repo_name=repo_name, commit_hash=commit.parent_hash) }}" class="hash">
                    {{ commit.parent_hash[:7] }}
                </a>
            {% else %}
                <span style="color: #8b949e;">(initial commit)</span>
            {% endif %}
        </div>
        <div>
            <strong>Tree:</strong>
            <a href="{{ url_for('repo.tree_view', repo_name=repo_name, branch=commit.hash) }}" class="hash">{{ commit.tree_hash[:7] }}</a>
        </div>
        {% if branch_names %}
        <div>
            <strong>Branch{{ 'es' if branch_names|length > 1 else '' }}:</strong>
            {% for branch in branch_names %}
                <a href="{{ url_for('repo.tree_view', repo_name=repo_name, branch=branch) }}" style="display: inline-block; margin-right: 8px; padding: 2px 8px; background-color: #1f6feb; color: white; border-radius: 12px; font-size: 12px; text-decoration: none;">
                    {{ branch }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- File Changes -->
{% if file_diffs %}
    <div style="margin-bottom: 16px;">
        <div class="card" style="padding: 12px 16px;">
            <strong>{{ file_diffs|length }} file{% if file_diffs|length != 1 %}s{% endif %} changed</strong>
        </div>
    </div>

    {% for file_diff in file_diffs %}
        <div class="card" style="margin-bottom: 16px; padding: 0; overflow: hidden;">
            <!-- File header -->
            <div style="padding: 8px 16px; background-color: #161b22; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if file_diff.change_type.value == 'added' %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #3fb950; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">A</span>
                        <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=commit.hash, file_path=file_diff.path) }}" style="font-family: monospace; font-weight: 600; color: #c9d1d9; text-decoration: none;">{{ file_diff.path }}</a>
                    {% elif file_diff.change_type.value == 'removed' %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #f85149; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">D</span>
                        <strong style="font-family: monospace;">{{ file_diff.path }}</strong>
                    {% else %}
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #d29922; color: #0d1117; border-radius: 3px; font-weight: 600; font-size: 11px;">M</span>
                        <a href="{{ url_for('repo.blob_view', repo_name=repo_name, branch=commit.hash, file_path=file_diff.path) }}" style="font-family: monospace; font-weight: 600; color: #c9d1d9; text-decoration: none;">{{ file_diff.path }}</a>
                    {% endif %}
                </div>
                {% if file_diff.lines and not file_diff.is_binary %}
                    {% set additions = file_diff.lines | selectattr('change_type', 'equalto', 'add') | list | length %}
                    {% set deletions = file_diff.lines | selectattr('change_type', 'equalto', 'remove') | list | length %}
                    {% if additions > 0 or deletions > 0 %}
                        <div style="display: flex; gap: 12px; font-size: 12px; font-family: monospace;">
                            {% if additions > 0 %}
                                <span style="color: #3fb950;">+{{ additions }}</span>
                            {% endif %}
                            {% if deletions > 0 %}
                                <span style="color: #f85149;">-{{ deletions }}</span>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Diff content -->
            {% if file_diff.is_binary %}
                <div style="padding: 16px; text-align: center; color: #8b949e;">
                    Binary file not shown
                </div>
            {% elif file_diff.lines %}
                <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 12px;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0;">
                        <tbody>
                            {% for line in file_diff.lines %}
                                <tr style="
                                    {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.15);
                                    {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.15);
                                    {% endif %}
                                ">
                                    <!-- Old line number -->
                                    <td style="width: 40px; padding: 0 8px; text-align: right; color: #8b949e; user-select: none; border-right: 1px solid #30363d;
                                        {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.1);
                                        {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.1);
                                        {% endif %}
                                    ">
                                        {% if line.line_number_old %}{{ line.line_number_old }}{% endif %}
                                    </td>
                                    <!-- New line number -->
                                    <td style="width: 40px; padding: 0 8px; text-align: right; color: #8b949e; user-select: none; border-right: 1px solid #30363d;
                                        {% if line.change_type == 'add' %}background-color: rgba(46, 160, 67, 0.1);
                                        {% elif line.change_type == 'remove' %}background-color: rgba(248, 81, 73, 0.1);
                                        {% endif %}
                                    ">
                                        {% if line.line_number_new %}{{ line.line_number_new }}{% endif %}
                                    </td>
                                    <!-- Change indicator -->
                                    <td style="width: 20px; padding: 0 4px; text-align: center; user-select: none;
                                        {% if line.change_type == 'add' %}color: #3fb950;
                                        {% elif line.change_type == 'remove' %}color: #f85149;
                                        {% endif %}
                                    ">
                                        {% if line.change_type == 'add' %}+
                                        {% elif line.change_type == 'remove' %}âˆ’
                                        {% endif %}
                                    </td>
                                    <!-- Line content -->
                                    <td style="padding: 0 8px; white-space: pre; overflow-x: auto;">{{ line.content }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="padding: 16px; text-align: center; color: #8b949e;">
                    Empty file
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <div class="card">
        <p style="color: #8b949e; font-style: italic;">No changes in this commit</p>
    </div>
{% endif %}
{% endblock %}
